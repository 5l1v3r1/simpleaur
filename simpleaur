#!/bin/sh
# install AUR packages
basebuilddir="$HOME/.simpleaur/Build" #Define the base Build DIR
vimexist=$(which vim 2> /dev/null)

#Check if the base Build DIR exists, if not create it.
if [ ! -d "$basebuilddir" ]; then
    mkdir -p "$basebuilddir"
fi

if [[ "$@" ]]; then
    cd "$basebuilddir" || exit
fi

# Download the PKGBUILDs.
for ipackage in "$@"; do
    git clone "https://aur.archlinux.org/${ipackage}.git"
done


# Check PKGBUILDs.
for ipackage in "$@"; do
    cd "$basebuilddir/$ipackage"
    read -s -r -n 1 -p "View PKGBUILD for ${ipackage}? [y/n]"$'\n' answer
    [[ "${answer,,}" =~ ^(yes|y)$ ]] && "$EDITOR" PKGBUILD
done

cd "$basebuilddir"

# Install packages.
for ipackage in "$@"; do
    #Check if PKGBUILD exist
    if [ -f "$ipackage/PKGBUILD" ]; then
        cd "$ipackage"
        makepkg -sci
        if [ "$?" -eq 0 ]; then
            #Ask to the user if want to remove the directory created for git
            read -p "Remove build directory? [Y/n]? " yn
            #Take the answer from the user input and decide what to do.
            if [ "$yn" = "y" ]; then
                printf "\e[1;32m%-6s\e[m\n%s\n" "Removing build directory..."
                rm -rf "$basebuilddir/$ipackage"
            else
                printf "\e[1;32m%-6s\e[m\n%s\n" "Instalation completed."
            fi
        else
            printf "\e[1;31m%-6s\e[m%s\n" "Installation not completed."
        fi
        cd "$basebuilddir"
    else
        printf "\e[1;31m%-6s\e[m%s\n" "The PKGBUILD file for $ipackage does not exist, please check your internet connection and make sure that the AUR package name exists, you can use simplesearch for that."
        printf "\e[1;32m%-6s\e[m\n%s\n" "Removing the failed build directory..."
        rm -rf "$basebuilddir/$ipackage"
    fi
done
